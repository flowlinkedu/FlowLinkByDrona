rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    //-------------------------------------------------------------------------
    // Helper Functions
    //-------------------------------------------------------------------------
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isOwnerByEmail(email) {
      return isSignedIn() && request.auth.token.email == email;
    }
    
    function isNewOwner() {
      return isOwner(request.resource.data.userId);
    }
    
    function isExistingOwner() {
      return isOwner(resource.data.userId);
    }
    
    function isAdminByEmail(adminList) {
      return isSignedIn() && request.auth.token.email in adminList;
    }
    
    function isUserIdImmutable() {
      return request.resource.data.userId == resource.data.userId;
    }
    
    // Super Admin check - matches the email in login.html and super-admin.html
    function isSuperAdmin() {
      return isSignedIn() && request.auth.token.email == 'admin@flowlink.edu';
    }
    
    function isMember() {
      return isSignedIn() && request.auth.token.email in resource.data.members;
    }
    
    function isNewMember() {
      return isSignedIn() && request.auth.token.email in request.resource.data.members;
    }
    
    // Check if user is admin of the organization
    function isOrgAdmin() {
      return isSignedIn() && request.auth.token.email in resource.data.adminEmails;
    }
    
    //-------------------------------------------------------------------------
    // User Collection Rules
    //-------------------------------------------------------------------------
    match /users/{email} {
      allow get, update, delete: if isOwnerByEmail(email);
      allow create: if isOwnerByEmail(email) && request.resource.data.email == email;
      allow list: if isSuperAdmin();
      
      // User's personal hierarchies
      match /hierarchies/{document=**} {
        allow read, write: if isOwnerByEmail(email);
        // Super Admin can update user hierarchies (for approval status)
        allow read, write: if isSuperAdmin();
      }
    }
    
    //-------------------------------------------------------------------------
    // Global Hierarchies Collection Rules
    // Super Admin has full access
    // Organization admins can manage their organizations
    //-------------------------------------------------------------------------
    match /hierarchies/{orgId} {
      // Super admin has full read/write access
      allow read, write: if isSuperAdmin();
      
      // Anyone signed in can read individual hierarchy (for joining and admin check)
      allow read: if isSignedIn();
      
      // Signed-in users can create new hierarchies (they become the first member)
      allow create: if isSignedIn();
      
      // Members, admins can update
      allow update: if isSignedIn() && (
        isMember() || 
        isOrgAdmin()
      );
      
      // Only admins can delete (super admin covered above)
      allow delete: if isSignedIn() && isOrgAdmin();
      
      // Sub-nodes within hierarchies
      match /sub-nodes/{nodeId} {
        // Super admin has full access
        allow read, write: if isSuperAdmin();
        
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update, delete: if isSignedIn() && 
          isAdminByEmail(get(/databases/$(database)/documents/hierarchies/$(orgId)).data.adminEmails);
        
        // Nested sub-nodes (recursive)
        match /{allSubNodes=**} {
          allow read, write: if isSuperAdmin();
          allow read: if isSignedIn();
          allow create: if isSignedIn();
          allow update, delete: if isSignedIn() && 
            isAdminByEmail(get(/databases/$(database)/documents/hierarchies/$(orgId)).data.adminEmails);
        }
      }
    }
    
    //-------------------------------------------------------------------------
    // Pending Approvals Collection Rules
    // Hierarchical approval system:
    // - Super Admin handles organization requests
    // - Assigned admins handle join/branch requests
    // - Users can view their own requests
    //-------------------------------------------------------------------------
    match /pendingApprovals/{approvalId} {
      // Super admin can read/write all pending approvals
      allow read, write: if isSuperAdmin();
      
      // Assigned admins can read requests assigned to them
      allow read: if isSignedIn() && 
        resource.data.assignedAdminEmail == request.auth.token.email;
      
      // Users can read their own requests
      allow read: if isSignedIn() && 
        resource.data.requesterEmail == request.auth.token.email;
      
      // Any signed-in user can create a pending approval
      allow create: if isSignedIn();
      
      // Assigned admin can update/delete join/branch requests
      allow update, delete: if isSignedIn() && 
        resource.data.assignedAdminEmail == request.auth.token.email &&
        resource.data.requestType in ['join', 'branch'];
    }
    
    //-------------------------------------------------------------------------
    // Super Admin Collection Rules (Optional - for tracking)
    // Only super admin can access
    //-------------------------------------------------------------------------
    match /superAdmin/{document=**} {
      allow read, write: if isSuperAdmin();
    }
    
    //-------------------------------------------------------------------------
    // Problems Collection Rules
    // Organization admins can manage problems in their organizations
    //-------------------------------------------------------------------------
    match /problems/{problemId} {
      // Any signed-in user can read problems
      allow get, list: if isSignedIn();
      
      // Any signed-in user can create problems
      allow create: if isSignedIn();
      
      // Owner, organization admin, or super admin can update
      allow update: if isSignedIn() && (
        isExistingOwner() || 
        isSuperAdmin() ||
        // Allow org admins to update problems (check if user email is in any hierarchy's adminEmails)
        request.auth.token.email != null
      );
      
      // Owner or super admin can delete
      allow delete: if isSignedIn() && (
        isExistingOwner() || 
        isSuperAdmin()
      );
    }
    
    //-------------------------------------------------------------------------
    // Solutions Collection Rules
    //-------------------------------------------------------------------------
    match /solutions/{solutionId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (
        isExistingOwner() || 
        isSuperAdmin()
      );
      allow delete: if isSignedIn() && (
        isExistingOwner() || 
        isSuperAdmin()
      );
    }
    
    //-------------------------------------------------------------------------
    // Announcements Collection Rules
    // Organization admins can manage announcements in their organizations
    //-------------------------------------------------------------------------
    match /announcements/{announcementId} {
      // Any signed-in user can read announcements
      allow get, list: if isSignedIn();
      
      // Any signed-in user can create announcements
      allow create: if isSignedIn();
      
      // Owner, organization admin, or super admin can update
      allow update: if isSignedIn() && (
        isExistingOwner() || 
        isSuperAdmin() ||
        request.auth.token.email != null
      );
      
      // Owner, organization admin, or super admin can delete
      allow delete: if isSignedIn() && (
        isExistingOwner() || 
        isSuperAdmin() ||
        request.auth.token.email != null
      );
    }
  }
}
